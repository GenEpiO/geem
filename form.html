<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  <head profile="http://www.w3.org/2005/10/profile">
  <link rel="icon" type="image/ico" href="favicon.ico">
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genomic Epidemiology Entity Mart Form Viewer</title>
    <link rel="stylesheet" href="css/foundation.min.css">
    <link rel="stylesheet" href="css/foundation-icons/foundation-icons.css">
    <link rel="stylesheet" href="css/foundation-datepicker.min.css">
    <link rel="stylesheet" href="js/chosen/chosen.css">
    <link rel="stylesheet" href="css/app.css">
  </head>
  <body>

    <div class="row">

      <!-- ************************ ONTOLOGY MENU AND SEARCH ********************* -->
      <div class="large-3 medium-3 columns" id="sidebar">
        <br/>

        <hr size="2"/>

        <ul class="vertical menu" id="entityMenu">
          <li>
            <a href="index.html">GEEM Introduction</a>
          </li>
          <li>
            <a href="portal.html">GEEM Portal</a>
          </li>
          <li class="active">
            <a href="#">GEEM Form Viewer</a>
          </li>
        </ul>

        <hr size="2"/>

        <div id="formSections"></div>

      </div>

      <!-- ************************ CONTENT AREA ********************* -->
      <div class="large-6 medium-6 columns" style="margin-top:25px;position:relative;border:2px solid black;max-height: 620px;overflow:scroll">
        <form id="mainForm" data-abide="ajax" style="margin-top:35px;">
            This GEEM form viewer can render the HTML form for a given ontology identifier (assuming it has been annotated as a GEEM specification). Simply include the identifier of the desired form, for example:

            <a href="http://genepio.org/geem/form.html#obolibrary:GENEPIO_0001624">
              http://genepio.org/geem/form.html#obolibrary:GENEPIO_0001624
            </a>
            <br/>
            <br/>
        </form>

      </div>

      <div class="large-3 medium-3 columns" id="rightbar">
        <br/>

        <div style=" margin-top:5px;border:1px solid silver;border-radius:4px;background-color:lightblue;padding:10px">
          <div class="switch tiny float-left" style="margin-right:15px;margin-bottom:0  ">
            <input class="switch-input" id="toggleMinimalForm" type="checkbox" name="toggleMinimalForm">
            <label class="switch-paddle" for="toggleMinimalForm">
              <span class="show-for-sr">Minimize form view</span>
            </label>
          </div>
          <span>Minimize form view</span>
        </div>
          <p>When minimize form is activated, only required fields or fields with selections will show their input elements. All other fields will be shown by label only. Mousing over a minimized field label will open it to its full size for data entry.</p>

        <div style="margin-top:15px;margin-right:10px;border:1px solid silver;border-radius:4px;background-color:lightblue;padding:13px">
            <button id="viewSpecification">View JSON Specification</button>
        </div>
        <p>This provides a view of the JSON specification file used to construct this form.</p>


      <div class="reveal small" id="modalEntity" data-reveal style="max-height:500px;overflow:scroll">
        <button class="close-button" data-close aria-label="Close reveal" type="button">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="row"></div>
      </div>

    </div>
    <br clear="all"/>

    <div class="row footer">
      <div class="large-12 columns text-center">
        <p>Produced by the <a href="www.irida.ca" target="_blank">IRIDA project</a> and <a href="https://github.com/Public-Health-Bioinformatics" target="_blank">Public Health Bioinformatics</a> in conjunction with the <a href="https://github.com/GenEpiO/genepio/wiki" target="_blank">GenEpiO Consortium</a></p>
      </div>
    </div>

    <script src="js/vendor/jquery.js"></script>
    <script src="js/vendor/what-input.js"></script>
    <script src="js/vendor/foundation.min.js"></script>
    <script src="js/vendor/foundation-datepicker.js"></script>
    <script src="js/OntologyForm.js"></script>
    <script src="js/chosen/chosen.jquery.min.js" type="text/javascript"></script>
    <script src="js/vendor/js-yaml.min.js"></script> <!-- http://adilapapaya.com/docs/js-yaml/ -->
    <script>

      $( document ).ready(function() {

        OntologyForm.initFoundation()
        $('#modalEntity').foundation()


        $('button#viewSpecification').on('click', function() {

          // This displays the entity json object as an indented hierarchy of text inside html <pre> tag.
          var html = [
              '<p><strong>'
              ,   "Simple YAML Specification"
              , '</strong></p>\n'
              , '<pre style="white-space: pre-wrap;">'
              ,   jsyaml.dump(getEntitySpecForm(focusEntityId), 4)
              , '</pre>\n'
            ].join('')
          $("#modalEntity > div.row").html(html )
          $("#modalEntity").foundation('open')
        })


        //Default load of GenEpiO
        loadSpecification('data/ontology/genepio-merged.json')

      });


      function loadSpecification(specification_file) {
        $.getJSON(specification_file, function(specification) {
          // Setup Zurb Foundation user interface and form validation
          loadForm(specification)
        });
      }

      function loadForm(specification) {

        myForm = new OntologyForm("#mainForm", specification['specifications'], top.formSettings)

        // PREFIX SHOULD INDICATE WHICH ONTOLOGY SPEC FILE TO LOAD?
        var focusEntityId = document.location.hash.substr(1).split('/',1)[0]
        top.focusEntityId = focusEntityId
        if (focusEntityId && focusEntityId.indexOf(':')) {
          myForm.renderEntity(focusEntityId)
          doSectionMenu()
        }
      
        // Toggle to hide all optional empty input content for concise display.
        $('input#toggleMinimalForm').on('change', function() {
          myForm.settings.minimalForm = $(this).is(':checked')
          myForm.renderEntity()
        })

      }

      // FOR DEMO PURPOSES ONLY, NORMALLY NO HASH CHANGE NEEDS TO BE DETECTED
      $(window).on('hashchange', function(){ 
        // GEEM focuses on entities by way of a URL with hash #[entityId]
          if (location.hash.length > 0)
            // Better entity id detection?
            if (location.hash.indexOf(':') != -1) { //.substr(0,5) =='#obolibrary:'
              focusEntityId = document.location.hash.substr(1)
              // PREFIX SHOULD INDICATE WHICH ONTOLOGY SPEC FILE TO LOAD?
              myForm.renderEntity(focusEntityId)
              doSectionMenu()
            }
      });

      function doSectionMenu() {
        // Provide form menu to two levels down.
        $('#formSections').empty()
        var sections = 0
        var sectionHTML = ''
        $('#mainForm .field-wrapper.model').each(function(index){
          sections += 1;
          var classes = $(this).attr('class')
          var depth = classes.substr(classes.indexOf('depth')+5)
          if (parseInt(depth) < 2) {
            var id = $(this).attr('data-ontology-id')
            var label = $(this).children('label').text()
            sectionHTML += '<li class="depth'+ depth + '"><a href="#' + id + '">' + label + '</a></li>'
          }
        });

        if (sections > 1) {
          $('#formSections').html('<h5>Form Sections</h5>\n' + '<ul class="vertical menu" id="formMenu">' + sectionHTML + '</ul>')
        }
      }

    </script>
  </body>

</html>
